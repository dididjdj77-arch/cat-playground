# ADR-002: Observation Storage – H3 Hybrid & Atomic Write

## 상태
Accepted (업데이트)

## 배경
기존 H2 설계는 JSONB 중심 저장으로 초기 유연성은 확보했으나, 검색/필터/통계 성능 저하, 인덱스 활용의 제약, 타입 검증 부재로 인한 데이터 품질 리스크가 누적되었다. 또한 UI 1카드=DB N레코드 저장에서 부분 성공이 발생할 수 있어 원자성 문제가 지적되었다.

## 결정
1) **H3 하이브리드 저장**: 자주 조회/필터/통계에 쓰이는 핵심 필드는 정규 컬럼(+인덱스)으로 승격하고, 롱테일/가변 정보만 JSONB로 유지한다.

2) **원자적 저장**: 멀티캣 관찰 저장은 서버 측 트랜잭션 경계로 묶는다. Supabase RPC(또는 동등한 서버 트랜잭션)에서 **그룹 생성 + N레코드 upsert**를 단일 트랜잭션으로 처리하며, 실패 시 전체 롤백한다.

## 근거
- **검색/통계**: 컬럼 인덱스로 예측 가능한 성능
- **인덱스**: JSONB GIN 의존 감소
- **검증**: 타입/제약으로 품질 보장
- **원자성**: 데이터 찢김 방지

## 범위 명시
- **어떤 필드를 정규 컬럼으로 승격할지**는 **정책(원칙)만 잠금**한다.
- **구체적인 필드 목록**은 OPEN 항목으로 남기며, v1 확정 시 별도 결정/ADR로 고정한다.

## 트랜잭션 경계(문서화)
- 입력: observation_group, observations[N]
- 처리: begin → create group → upsert observations[N] → commit
- 실패: rollback

## 결과
성능·품질·일관성 개선. 초기 마이그레이션 비용은 있으나 장기 운영 리스크 감소.
