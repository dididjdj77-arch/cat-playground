# ADR-004 JSONB meta promotion — 승격 트리거/백필/SSOT 전환

- 상태: Accepted
- 날짜: 2026-01-30
- 관련 결정: D-030

문제:
- inventory_items.meta(JSONB)가 확장 슬롯으로 유효하지만, 시간이 지나면 조회/필터/집계 성능과 데이터 일관성이 무너질 수 있다.
- meta에 쌓인 키를 “언제/어떻게” 컬럼으로 승격할지(백필/SSOT 전환/호환) 절차가 없으면 meta가 영구 창고가 된다.

배경:
- v1.1은 유연성(B)을 우선하되, 향후 정규화(C)로 이동 가능한 구조를 유지한다.
- 승격은 기능 확장이 아니라 “운영/성능/일관성”을 위한 구조적 정리 행위다.

선택지:
- A) meta에 계속 누적(승격 규칙 없음)
- B) 승격 규칙 + 백필 템플릿 + SSOT 전환(dual-write 금지)  ← 채택
- C) 즉시 정규 테이블/코드북으로 분해

결정:
- meta는 “임시 확장 슬롯”이며, 특정 키가 아래 조건을 충족하면 승격(Promotion)한다.
  - 조회/필터/집계에서 반복적으로 쓰이는 키(구체 수치는 OPEN에서 결정)
  - 사업적으로 의미 있는 지표(상품/API에 직접 반영)
  - 타입/단위/네이밍이 안정화됨
- 승격 절차(필수):
  1) 컬럼 추가
  2) one-shot backfill 실행(기존 row meta → 컬럼)
  3) 승격 키에 대해 SSOT를 컬럼으로 전환(dual-write 금지)
  4) 승격 키 meta 입력 처리 정책:
     - 호환 기간(필요 시): 입력을 수용하되 컬럼으로 canonicalize하고 meta에서 제거
     - 이후: 승격 키 meta 입력은 거부(readonly)
- “준정규(lookup)” 단계는 C로 가기 전 중간 단계로 허용한다:
  - 고유값이 커지고(중복 많음) 조회가 잦은 속성은 lookup_<type> 테이블로 분리 가능(구체 기준은 OPEN)

결과/영향:
- 장점: 스키마 드리프트 방지, 성능/집계 품질 개선, 장기 유지보수 용이
- 단점: 승격 시 마이그레이션 작업이 필요(백필/검증)
- 리스크: 구버전 클라이언트가 meta로 계속 보내는 경우 → “호환 기간 canonicalize”로 완충

후속 작업:
- migrate_meta_key(key, column) 템플릿(TODO)과 첫 실험키로 승격 리허설을 수행한다.
